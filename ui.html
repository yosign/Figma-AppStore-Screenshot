<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>Super Screenshot</title>
    <!-- 引入 Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      /* 基础样式调整，整体更紧凑，字体更小 */
      body {
        background-color: #f5f5f5;
        font-size: 13px;
        padding: 12px;
      }
      .container {
        padding: 12px;
        max-width: 900px;
        margin: 16px auto;
        background: #fff;
        border-radius: 4px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      }
      .card {
        margin-bottom: 12px;
        font-size: 13px;
      }
      .card-header {
        padding: 8px 12px;
        font-weight: 600;
        font-size: 14px;
      }
      .card-body {
        padding: 8px 12px;
      }
      .form-label {
        font-size: 13px;
      }
      .form-control {
        font-size: 13px;
        margin-bottom: 12px;
      }
      .form-select {
        font-size: 13px;
        margin-bottom: 12px;
      }
      .btn {
        font-size: 13px;
        padding: 6px 12px;
        width: 100%;
      }
      .my-4 {
        margin: 16px 0 !important;
      }
      .mb-3 {
        margin-bottom: 12px !important;
      }
      .row.g-3 > [class*="col-"] {
        padding-left: 4px;
        padding-right: 4px;
      }
      /* 搜索结果样式 */
      .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }
      .search-results.show {
        display: block;
      }
      .search-item {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .search-item:hover {
        background-color: #f8f9fa;
      }
      .search-item img {
        width: 40px;
        height: 40px;
        border-radius: 8px;
      }
      .search-item-info {
        flex: 1;
      }
      .search-item-name {
        font-weight: 500;
        margin-bottom: 2px;
      }
      .search-item-developer {
        font-size: 12px;
        color: #666;
      }
      .search-item-price {
        font-size: 12px;
        color: #28a745;
      }
      .input-group {
        position: relative;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <!-- 搜索输入组 -->
      <div class="mb-3">
        <label for="searchInput" class="form-label">应用搜索</label>
        <div class="input-group">
          <input
            type="text"
            class="form-control"
            id="searchInput"
            placeholder="输入应用名称或 App ID"
          />
          <div class="search-results" id="searchResults"></div>
        </div>
      </div>

      <!-- 国家选择 -->
      <div class="mb-3">
        <label for="countrySelect" class="form-label">App Store 地区</label>
        <select class="form-select" id="countrySelect">
          <option value="us" selected>United States</option>
          <option value="cn">China</option>
          <option value="gb">United Kingdom</option>
          <option value="jp">Japan</option>
          <option value="kr">Korea</option>
        </select>
      </div>

      <!-- 布局设置 -->
      <div class="row g-3 mb-3">
        <div class="col-6">
          <label for="iconSizeInput" class="form-label">图标尺寸</label>
          <input
            type="number"
            class="form-control"
            id="iconSizeInput"
            value="256"
          />
        </div>
        <div class="col-6">
          <label for="spacingInput" class="form-label">间距</label>
          <input
            type="number"
            class="form-control"
            id="spacingInput"
            value="24"
          />
        </div>
      </div>

      <!-- 截图设置 -->
      <div class="mb-3">
        <label for="screenshotWidthInput" class="form-label">截图宽度</label>
        <input
          type="number"
          class="form-control"
          id="screenshotWidthInput"
          value="375"
        />
      </div>

      <!-- 提交按钮 -->
      <button class="btn btn-primary" id="createLayoutBtn" disabled>
        采集包装
      </button>

      <!-- 进度显示区域 -->
      <div class="progress mt-3" style="display: none;">
        <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      </div>
      <div class="text-center mt-2 text-muted" id="progressText" style="display: none; font-size: 12px;">
        正在处理...
      </div>
    </div>

    <!-- 引入 Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // 获取 DOM 元素
      const searchInput = document.getElementById('searchInput');
      const searchResults = document.getElementById('searchResults');
      const countrySelect = document.getElementById('countrySelect');
      const iconSizeInput = document.getElementById('iconSizeInput');
      const spacingInput = document.getElementById('spacingInput');
      const screenshotWidthInput = document.getElementById('screenshotWidthInput');
      const createLayoutBtn = document.getElementById('createLayoutBtn');

      let selectedApp = null;
      let searchTimeout = null;

      // 搜索输入处理
      searchInput.addEventListener('input', (e) => {
        const term = e.target.value.trim();
        
        // 清除之前的延时
        if (searchTimeout) {
          clearTimeout(searchTimeout);
        }

        // 如果输入是纯数字（App ID），直接启用按钮
        if (/^\d+$/.test(term)) {
          selectedApp = { id: term };
          createLayoutBtn.disabled = false;
          searchResults.classList.remove('show');
          return;
        }

        // 如果输入少于2个字符，不执行搜索
        if (term.length < 2) {
          searchResults.classList.remove('show');
          createLayoutBtn.disabled = true;
          return;
        }

        // 设置300ms的延时后执行搜索
        searchTimeout = setTimeout(() => {
          parent.postMessage({
            pluginMessage: {
              type: 'search-apps',
              term: term,
              country: countrySelect.value
            }
          }, '*');
        }, 300);
      });

      // 处理搜索结果点击
      searchResults.addEventListener('click', (e) => {
        const item = e.target.closest('.search-item');
        if (item) {
          const appId = item.dataset.appId;
          const appName = item.dataset.appName;
          selectedApp = {
            id: appId,
            name: appName
          };
          searchInput.value = appName;
          searchResults.classList.remove('show');
          createLayoutBtn.disabled = false;
        }
      });

      // 点击外部关闭搜索结果
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.input-group')) {
          searchResults.classList.remove('show');
        }
      });

      // 创建布局按钮点击事件
      createLayoutBtn.onclick = () => {
        if (!selectedApp) {
          alert('请先选择一个应用');
          return;
        }

        // 发送消息到插件
        parent.postMessage({
          pluginMessage: {
            type: 'fetch-app',
            appId: selectedApp.id,
            country: countrySelect.value,
            config: {
              iconSize: parseInt(iconSizeInput.value) || 512,
              screenshotWidth: parseInt(screenshotWidthInput.value) || 320,
              spacing: parseInt(spacingInput.value) || 24
            }
          }
        }, '*');
      };

      // 监听插件消息
      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;
        
        if (msg.type === 'search-results') {
          // 显示搜索结果
          searchResults.innerHTML = msg.results.map(app => `
            <div class="search-item" data-app-id="${app.id}" data-app-name="${app.name}">
              <img src="${app.icon}" alt="${app.name}" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
              <div class="search-item-info">
                <div class="search-item-name">${app.name}</div>
                <div class="search-item-developer">${app.developer}</div>
              </div>
              <div class="search-item-price">${app.price}</div>
            </div>
          `).join('');
          
          searchResults.classList.add('show');
        } else if (msg.type === 'error') {
          alert(`错误: ${msg.message}`);
        } else if (msg.type === 'progress-update') {
          // 更新进度条
          const progressBar = document.querySelector('.progress');
          const progressBarInner = document.querySelector('.progress-bar');
          const progressText = document.getElementById('progressText');
          
          // 显示进度条和文本
          progressBar.style.display = 'flex';
          progressText.style.display = 'block';
          
          // 更新进度
          progressBarInner.style.width = `${msg.progress}%`;
          progressBarInner.setAttribute('aria-valuenow', msg.progress);
          
          // 更新文本
          progressText.textContent = msg.message;
          
          // 如果完成，3秒后隐藏进度条
          if (msg.progress === 100) {
            setTimeout(() => {
              progressBar.style.display = 'none';
              progressText.style.display = 'none';
            }, 3000);
          }
        }
      };
    </script>
  </body>
</html> 